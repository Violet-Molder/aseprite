name: Build Aseprite for Windows

on:
  workflow_dispatch:
    inputs:
      aseprite_version:
        description: 'Aseprite 源码版本（比如 v1.3.5）'
        required: true
        default: 'v1.3.5'
      skia_version:
        description: 'Skia 预编译版本（匹配 Aseprite，比如 m102）'
        required: true
        default: 'm102'

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
      - name: Checkout Runner
        uses: actions/checkout@v4

      # 关键修改：移除 toolset 14.38 的指定，使用默认版本
      - name: Setup Visual Studio Build Tools
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64  # 仅保留架构指定，删除 toolset 配置

      - name: Install Build Dependencies
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          choco install ninja -y
          choco install python -y
          refreshenv

      - name: Download Aseprite Source Code
        run: |
          git clone --depth 1 --branch ${{ github.event.inputs.aseprite_version }} https://github.com/aseprite/aseprite.git ${{ github.workspace }}\aseprite
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Prebuilt Skia
        run: |
          mkdir -p ${{ github.workspace }}\skia
          cd ${{ github.workspace }}\skia
          $skia_url = "https://github.com/aseprite/skia/releases/download/${{ github.event.inputs.skia_version }}/Skia-Windows-Release-x64.zip"
          Invoke-WebRequest -Uri $skia_url -OutFile skia.zip
          Expand-Archive -Path skia.zip -DestinationPath . -Force

      - name: Configure CMake
        run: |
          mkdir -p ${{ github.workspace }}\aseprite\build
          cd ${{ github.workspace }}\aseprite\build
          cmake .. ^
            -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}\aseprite\install ^
            -DLAF_BACKEND=skia ^
            -DSKIA_DIR=${{ github.workspace }}\skia ^
            -DSKIA_LIBRARY_DIR=${{ github.workspace }}\skia\out\Release-x64 ^
            -DSKIA_LIBRARY=${{ github.workspace }}\skia\out\Release-x64\skia.lib ^
            -DUSE_SHARED_CRT=off ^
            -DUSE_ALLEGRO4=off ^
            -DUSE_FAKE_ALLEGRO4=on

      - name: Build Aseprite
        run: |
          cd ${{ github.workspace }}\aseprite\build
          ninja install

      - name: Package Aseprite
        run: |
          Compress-Archive -Path ${{ github.workspace }}\aseprite\install\* -DestinationPath ${{ github.workspace }}\Aseprite-Win-${{ github.event.inputs.aseprite_version }}.zip

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Aseprite-Win-${{ github.event.inputs.aseprite_version }}
          path: ${{ github.workspace }}\Aseprite-Win-${{ github.event.inputs.aseprite_version }}.zip
          retention-days: 30
