name: Build Aseprite on Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        # 可选择构建特定版本，如测试版1.3.17
        # ref: v1.3.17
    
    - name: Set up Visual Studio environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        toolset: 14.39
    
    - name: Install CMake and Ninja
      uses: lukka/get-cmake@latest
    
    - name: Download Skia library
      run: |
        mkdir -p third_party/skia
        Invoke-WebRequest -Uri "https://github.com/aseprite/skia/releases/download/m102-861e4743af/Skia-Windows-Release-x64.zip" -OutFile "skia.zip"
        Expand-Archive -Path "skia.zip" -DestinationPath "third_party/skia" -Force
        Remove-Item -Path "skia.zip" -Force
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -G Ninja `
          -DCMAKE_BUILD_TYPE=Release `
          -DLAF_BACKEND=skia `
          -DSKIA_DIR="../third_party/skia" `
          -DSKIA_LIBRARY_DIR="../third_party/skia/out/Release-x64" `
          -DSKIA_LIBRARY="../third_party/skia/out/Release-x64/skia.lib" `
          -DFREETYPE_LIBRARY="../third_party/skia/third_party/freetype/lib/Release/freetype.lib" `
          -DFREETYPE_INCLUDE_DIRS="../third_party/skia/third_party/freetype/include"
    
    - name: Build Aseprite
      run: |
        cd build
        ninja aseprite
    
    - name: Package artifacts
      run: |
        mkdir -p dist
        Copy-Item -Path "build/bin/aseprite.exe" -Destination "dist/"
        Copy-Item -Path "build/bin/aseprite.pdb" -Destination "dist/" -ErrorAction SilentlyContinue
        Copy-Item -Path "data" -Destination "dist/" -Recurse
        Compress-Archive -Path "dist/*" -DestinationPath "aseprite-windows.zip" -Force
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-windows
        path: aseprite-windows.zip
        retention-days: 7
